%% ebproof.tex
%% Copyright 2015-2018 Emmanuel Beffara <manu@beffara.org>
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% This work has the LPPL maintenance status `maintained'.
%
% The Current Maintainer of this work is Emmanuel Beffara.
%
% This work consists of the files ebproof.sty and ebproof.tex.

\documentclass{l3doc}
\DeclareRobustCommand\package[1]{\textsf{#1}}

\title{The \package{ebproof} package}
\author{Emmanuel Beffara -- \url{manu@beffara.org}}
\date{Version 2.0 -- March 17, 2017}

\usepackage{tikz}
\usetikzlibrary{decorations.pathmorphing}

\usepackage{ebproof}

\newenvironment{example}{%
  \VerbatimEnvironment
  \begin{VerbatimOut}{example.tex}}{%
  \end{VerbatimOut}
  \begin{center}
  \begin{minipage}{.4\textwidth}
    \input{example.tex}
  \end{minipage}%
  \begin{minipage}{.6\textwidth}
    \small\VerbatimInput[gobble=0]{example.tex}
  \end{minipage}%
  \end{center}
}

\begin{document}
\maketitle

\tableofcontents

\section{Introduction}

The \env{ebproof} package provides commands to typeset proof trees, in the
style of sequent calculus and related systems:

\begin{example}
  \begin{prooftree}
    \hypo{ \Gamma, A &\vdash B }
    \infer1[abs]{ \Gamma &\vdash A\to B }
    \hypo{ \Gamma \vdash A }
    \infer2[app]{ \Gamma \vdash B }
  \end{prooftree}
\end{example}

The structure is very much inspired by the
\href{http://math.ucsd.edu/~sbuss/ResearchWeb/bussproofs/}{\package{bussproofs}}
package, in particular for the postfix notation.
I actually wrote \package{ebproof} because there were some limitations in
\package{bussproofs} that I did not know how to lift, and also because I did
not like some choices in that package (and also because it was fun to write).

Any feedback is welcome, in the form of bug reports, feature requests or
suggestions, through the web page of the project at \url{https://framagit.org/manu/ebproof}.

\section{Environments}

\DescribeEnv{prooftree}
\DescribeEnv{prooftree*}
The package provides the \env{prooftree} environment, in a standard and
starred variants.
\begin{syntax}
  \verb|\begin{prooftree}|\oarg{options}
  ~ \meta{statements}
  \verb|\end{prooftree}|
\end{syntax}
This typesets the proof tree described by the \meta{statements}, as described
in section~\ref{sec:statements}.
The \meta{options} provide default formatting options for the proof tree.

Following the conventions of \package{amsmath} for alignment environments, the
non-starred version produces a proof tree at the current position in the text
flow (it can be used in math mode or text mode) while the starred version
typesets the proof on a line of its own, like a displayed formula.

\begin{example}
  \[
    \begin{prooftree}
      \infer0{ \vdash A }
      \hypo{ \vdash B } \infer1{ \vdash B, C }
      \infer2{ \vdash A\wedge B, C }
    \end{prooftree}
    \quad \rightsquigarrow \quad
    \begin{prooftree}
      \infer0{ \vdash A } \hypo{ \vdash B }
      \infer2{ \vdash A\wedge B }
      \infer1{ \vdash A\wedge B, C }
    \end{prooftree}
  \]
\end{example}

\section{Statements}
\label{sec:statements}

Statements describe proofs in postfix notation: when typesetting a proof tree
whose last rule has, say, two premisses, you will first write statements for
the subtree of the first premiss, then statements for the subtree of the
second premiss, then a statement like \cs{infer2}\{\meta{conclusion}\} to
build an inference with these two subtrees as premisses and the given text as
conclusion.

Hence statements operate on a stack of proof trees.
At the beginning of a \env{prooftree} environment, the stack is empty.
At the end, it must contain exactly one tree, which is the one that will be
printed.

Note that the commands defined in this section only exist right inside
\env{prooftree} environments.
If you have a macro with the same name as one of the statements, for instance
\cs{hypo}, then this macro will keep its meaning outside \env{prooftree}
environments as well as inside the arguments of a statement.
If you really need to access the statements in another context, you can can
always call them by prefixing their names with \texttt{ebproof}, for instance as
\cs{ebproofhypo}.

\subsection{Basic statements}

The basic statements for building proofs are the following, where
\meta{options} stands for arbitrary options as described in
section~\ref{sec:options}.

\DescribeMacro{\hypo}
The statement \cs{hypo} pushes a new proof tree consisting only in one
conclusion line, with no premiss and no line above, in other words a tree with
only a leaf (\cs{hypo} stands for \emph{hypothesis}).
\begin{syntax}
  \cs{hypo}\oarg{options}\marg{text}
\end{syntax}

\DescribeMacro{\infer}
The statement \cs{infer} builds an inference step by taking some proof trees
from the top of the stack, assembling them with a rule joining their
conclusions and putting a new conclusion below.
\begin{syntax}
  \cs{infer}\oarg{options}\meta{arity}\oarg{label}\marg{text}
\end{syntax}
The \meta{arity} is the number of sub-proofs, it may be any number
including 0 (in this case there will be a line above the conclusion but no
sub-proof).
If \meta{label} is present, it is used as the label on the right of the
inference line; it is equivalent to using the \cmd{right label} option.

\medskip

The \meta{text} in these statements is the contents of the conclusion at the
root of the tree that the statements create.
It is typeset in math mode by default but any kind of formatting can be used
instead, using the \cmd{template} option.
The \meta{label} text is formatted in horizontal text mode by default.

Each proof tree has a vertical axis, used for alignment of successive steps.
The position of the axis is deduced from the text of the conclusion at the
root of the tree: if \meta{text} contains the alignment character \verb|&|
then the axis is set at that position, otherwise the axis is set at the center
of the conclusion text.
The \cs{infer} statement makes sure that the axis of the premiss is at the
same position as the axis of the conclusion.
If there are several premisses, it places the axis at the center between the
left of the leftmost conclusion and the right of the rightmost conclusion:

\begin{example}
  \begin{prooftree}
    \hypo{ &\vdash A, B, C }
    \infer1{ A &\vdash B, C }
    \infer1{ A, B &\vdash C }
    \hypo{ D &\vdash E }
    \infer2{ A, B, D &\vdash C, E }
    \infer1{ A, B &\vdash C, D, E }
    \infer1{ A &\vdash B, C, D, E }
  \end{prooftree}
\end{example}

\DescribeMacro{\ellipsis}
The statement \cs{ellipsis} typesets vertical dots, with a label on the right,
and a new conclusion. No inference lines are inserted.
\begin{syntax}
  \cs{ellipsis}\marg{label}\marg{text}
\end{syntax}
\begin{example}
  \begin{prooftree}
    \hypo{ \Gamma &\vdash A }
    \ellipsis{foo}{ \Gamma &\vdash A, B }
  \end{prooftree}
\end{example}


\subsection{Modifying proof trees}

The following additional statements may be used to affect the format of the
last proof tree on the stack.

\DescribeMacro{\rewrite}
The statement \cs{rewrite} is used to modify the proof of the stack while
preserving its size and alignment.
\begin{syntax}
  \cs{rewrite}\marg{code}
\end{syntax}
The \meta{code} is typeset in horizontal mode, with the following control
sequences defined:
\begin{itemize}
\item \cs{treebox} is a box register that contains the original material,
\item \cs{treemark}\marg{name} expands as the position of a given mark with
  respect to the left of the box.
\end{itemize}
A simple use of this statement is to change the color of a proof tree:
\begin{example}
  \begin{prooftree}
    \hypo{ \Gamma, A &\vdash B }
    \infer1[abs]{ \Gamma &\vdash A\to B }
    \rewrite{\color{red}\box\treebox}
    \hypo{ \Gamma \vdash A }
    \infer2[app]{ \Gamma \vdash B }
  \end{prooftree}
\end{example}
Note the absence of spaces inside the call to \cs{rewrite}, because spaces
would affect the position of the tree box.
Note also that explicit use of \cs{treebox} is required to actually draw the
subtree.
Not using it will effectively not render the subtree, while still reserving
its space in the enclosing tree:
\begin{example}
  \begin{prooftree}
    \hypo{ \Gamma, A &\vdash B }
    \infer1[abs]{ \Gamma &\vdash A\to B }
    \rewrite{}
    \hypo{ \Gamma \vdash A }
    \infer2[app]{ \Gamma \vdash B }
  \end{prooftree}
\end{example}
This kind of manipulation is useful for instance in conjunction with the
\package{beamer} package to allow revealing subtrees of a proof tree
progressively in successive slides of a given frame.

\DescribeMacro{\delims}
The statement \cs{delims} puts left and right delimiters around the whole
sub-proof, without changing the alignment (the spacing is affected by the
delimiters, however).
\begin{syntax}
  \cs{delims}\marg{left}\marg{right}
\end{syntax}
The \meta{left} text must contain an opening occurrence of \cs{left} and the
\meta{right} text must contain a matching occurrence of \cs{right}.
For instance, \verb|\delims{\left(}{\right)}| will put the
sub-proof between parentheses.
\begin{example}
  \begin{prooftree}
    \hypo{ A_1 \vee \cdots \vee A_n }
    \hypo{ [A_i] }
    \ellipsis{}{ B }
    \delims{ \left( }{ \right)_{1\leq i\leq n} }
    \infer2{ B }
  \end{prooftree}
\end{example}

\section{Options}
\label{sec:options}

The formatting of trees, conclusion texts and inference rules is affected by
options, specified using the \LaTeX3 key-value system.
All options are in the \texttt{ebproof} module in the key tree.
They can be set locally for a proof tree or for a single statement using
optional arguments in the associated commands.

\DescribeMacro{\ebproofset}
\DescribeMacro{\set}
The statement \cs{ebproofset} is used to set some options. When used inside a
\env{prooftree} environment, it can written \cs{set}.
\begin{syntax}
  \cs{ebproofset}\marg{options}
\end{syntax}
The options will apply in the current scope; using this in preamble will
effectively set options globally.
Specific options may also be specified for each proof tree and for each
statement in a proof tree, using optional arguments.

\subsection{General shape}

The options in this section only make sense at the global level and at the
proof level.
Changing the proof style inside a \env{proof} environment has undefined
behaviour.

\DescribeOption{proof style}
The option \cmd{proof style} sets the general shape for representing proofs.
The following styles are provided:
\begin{description}
\item[upwards] 
  This is the default style.
  Proof trees grow upwards, with conclusions below and premisses above.
\item[downwards]
  Proof trees grow downwards, with conclusions above and premisses below.
  \begin{example}
    \begin{prooftree}[proof style=downwards]
      \hypo{ \Gamma, A &\vdash B }
      \infer1[abs]{ \Gamma &\vdash A\to B }
      \hypo{ \Gamma \vdash A }
      \infer2[app]{ \Gamma \vdash B }
    \end{prooftree}
  \end{example}
\end{description}

In the optional argument of \env{prooftree} environments, proof styles can
be specified directly, without prefixing the name by ``\texttt{proof style=}''.
For instance, the first line of the example above could be written
\verb|\begin{prooftree}| equivalently.

\DescribeOption{center}
The option \cmd{center} toggles vertical centering of typeset proofs.
If set to \texttt{true}, the tree produced by the \env{prooftree} environment
will be vertically centered around the text line.
If set to \texttt{false}, the base line of the tree will be the base line of
the conclusion.
The default value is \texttt{true}.
\begin{example}
  \begin{prooftree}[center=false]
    \infer0{ A \vdash A }
  \end{prooftree}
  \qquad
  \begin{prooftree}[center=false]
    \hypo{ \Gamma, A \vdash B }
    \infer1{ \Gamma \vdash A \to B }
  \end{prooftree}
\end{example}

\subsection{Spacing}

\DescribeOption{separation}
Horizontal separation between sub-proofs in an inference is defined by the
option \cmd{separation}.
The default value is \texttt{1.5em}.
\begin{example}
  \begin{prooftree}[separation=0.5em]
    \hypo{ A } \hypo{ B } \infer2{ C }
    \hypo{ D } \hypo{ E } \hypo{ F } \infer3{ G }
    \hypo{ H } \infer[separation=3em]3{ K }
  \end{prooftree}
\end{example}

\DescribeOption{rule margin}
The spacing above and below inference lines is defined by the option
\cmd{rule margin}.
The default value is \texttt{0.7ex}.
\begin{example}
  \begin{prooftree}[rule margin=2ex]
    \hypo{ \Gamma, A &\vdash B }
    \infer1[abs]{ \Gamma &\vdash A\to B }
    \hypo{ \Gamma \vdash A }
    \infer2[app]{ \Gamma \vdash B }
  \end{prooftree}
\end{example}

\subsection{Shape of inference lines}

\DescribeOption{rule style}
The shape of inference lines is set by the option \cmd{rule style}.
The following values are provided:
\begin{description}
\item[simple]
  A simple horizontal rule is drawn.
  This is the default style.
\item[no rule]
  No line is drawn.
  A single space of the length of \texttt{rule margin} is inserted.
\item[double]
  A double line is drawn.
\item[dashed]
  A single dashed line is drawn.
\end{description}
The precise rendering is influenced by parameters specified below.
Arbitrary new shapes can defined using the \texttt{rule code} option described
below and the \cs{ebproofnewrulestyle} command described in
section~\ref{sec:styles}.

In the optional argument of the \cs{infer} statement, rule styles can be
specified directly, without prefixing the style name by ``\texttt{rule style=}''.
For instance, \verb|\infer[dashed]| is equivalent to
\verb|\infer[rule style=dashed]|.

\begin{example}
  \begin{prooftree}
    \hypo{ \Gamma &\vdash A \to B }
    \infer[no rule]1{ \Gamma &\vdash {!A} \multimap B }
    \hypo{ \Delta &\vdash A }
    \infer[rule thickness=2pt]1{ \Delta &\vdash {!A} }
    \infer0{ B \vdash B }
    \infer[dashed]2{ \Delta, {!A}\multimap B \vdash B }
    \infer2{ \Gamma, \Delta &\vdash B }
    \infer[double]1{ \Gamma \cup \Delta &\vdash B }
  \end{prooftree}
\end{example}

\DescribeOption{rule thickness}
\DescribeOption{rule separation}
The thickness of inference lines is defined by option \cmd{rule thickness},
it is \texttt{0.4pt} by default.
The distance between the two lines in the \texttt{double} rule style is
defined by the \cmd{rule separation} option.
It is \texttt{2pt} by default.
\DescribeOption{rule dash length}
\DescribeOption{rule dash space}
For dashed rules, the length of dashes is defined by the option
\cmd{rule dash length} and the space between dashes is defined by the option
\cmd{rule dash space}.
The default values are \texttt{0.2em} and \texttt{0.3em} respectively.

\DescribeOption{rule code}
Arbitrary rule shapes can be optained using the \cmd{rule code} option.
The argument is code is used to render the rule, it is executed in vertical
mode in a \cs{vbox} whose \cs{hsize} is set to the width of the rule.
Margins above and below are inserted automatically (they can be removed by
setting \texttt{rule margin} to \texttt{0pt}).

\begin{example}
  \begin{prooftree}[rule code={\hbox{\tikz
      \draw[decorate,decoration={snake,amplitude=.3ex}]
      (0,0) -- (\hsize,0);}}]
    \hypo{ \Gamma &\vdash A }
    \infer1{ \Gamma &\vdash A, \ldots, A }
    \hypo{ \Delta, A, \ldots, A \vdash \Theta }
    \infer2{ \Gamma, \Delta \vdash \Theta }
  \end{prooftree}
\end{example}
Note that this example requires the \package{tikz} package, with the
\package{decorations.pathmorphing} library for the \texttt{snake} decoration.

\subsection{Format of conclusions and labels}

\DescribeOption{template}
\DescribeOption{left template}
\DescribeOption{right template}
The format of text in inferences is defined by templates.
The option \cmd{template} is used for text with no alignment mark, the options
\cmd{left template} and \cmd{right template} are used for the left and right
side of the alignment mark when it is present.
The value of these options is arbitrary \TeX\ code, composed in horizontal mode.
The macro \cs{inserttext} is used to insert the actual text passed to the
\cs{hypo} and \cs{infer} statements.
The default value for \cmd{template} is simply \verb|$\inserttext$|, so that
conclusions are set in math mode.
The default values for \cmd{left template} and \cmd{right template} are
similar, with spacing assuming that a relation symbol is put near the
alignment mark, so that \verb|\infer1{A &\vdash B}| is spaced correctly.

\begin{example}
  \begin{prooftree}[template=(\textbf\inserttext)]
    \hypo{ foo }
    \hypo{ bar }
    \infer1{ baz }
    \infer2{ quux }
  \end{prooftree}
\end{example}

\DescribeOption{left label}
\DescribeOption{right label}
The text to use as the labels of the rules, on the left and on the right
of the inference line, is defined by the options \cmd{left label} and
\cmd{right label}.
Using the second optional argument in \cs{infer} is equivalent to setting
the \env{right label} option with the value of that argument.

\begin{example}
  \begin{prooftree}
    \hypo{ \Gamma, A &\vdash B }
    \infer[left label=$\lambda$]1[abs]
      { \Gamma &\vdash A\to B }
    \hypo{ \Gamma \vdash A }
    \infer[left label=@]2[app]{ \Gamma \vdash B }
  \end{prooftree}
\end{example}

\DescribeOption{left label template}
\DescribeOption{right label template}
Similarly to conclusions, labels are formatted according to templates.
The code is arbitrary \TeX\ code, composed in horizontal mode, where
the macro \cs{inserttext} can be used to insert the actual label text.
The default values are simply \cs{inserttext} so that labels are set in
plain text mode.
\DescribeOption{label separation}
The spacing between an inference line and its labels is defined by the option
\cmd{label separation}, the default value is \texttt{0.5em}.
The height of the horizontal axis used for aligning the labels with the
rules is defined by the option \cmd{label axis}, the default value is
\texttt{0.5ex}.


\subsection{Style macros}
\label{sec:styles}

The following commands allow for the definition of custom styles using the
basic style options, in a way similar to PGF's ``styles'' and \LaTeX3's
``meta-keys''.
This allows setting a bunch of options with the same values in many proofs
using a single definition.

\DescribeMacro{\ebproofnewstyle}
The statement \cs{ebproofnewstyle} defines a new style option with some
\meta{name} that sets a given set of \meta{options}:
\begin{syntax}
  \cs{ebproofnewstyle}\marg{name}\marg{options}
\end{syntax}
For instance, the following code defines a new option \cmd{small} that sets
various parameters so that proofs are rendered smaller.
\begin{example}
  \ebproofnewstyle{small}{
    separation = 1em, rule margin = .5ex,
    template = \footnotesize$\inserttext$ }
  \begin{prooftree}[small]
    \hypo{ \Gamma, A \vdash B }
    \infer1{ \Gamma \vdash A\to B }
    \hypo{ \Gamma \vdash A } \infer2{ \Gamma \vdash B }
  \end{prooftree}
\end{example}

\DescribeMacro{\ebproofnewrulestyle}
The statement \cs{ebproofnewrulestyle} does the same for rule styles:
\begin{syntax}
  \cs{ebproofnewrulestyle}\marg{name}\marg{options}
\end{syntax}
The \meta{options} part includes options used to set how to draw rules in
the new style.

The option \cmd{rule code} is useful in this command as it allows to
define arbitrary rule styles.
For instance, the squiggly rule example above could be turned into a new
rule style \texttt{zigzag} with the following code:
\begin{example}
  \ebproofnewrulestyle{zigzag}{
    rule code = {\hbox{\tikz
      \draw[decorate,decoration={snake,amplitude=.3ex}]
      (0,0) -- (\hsize,0);}}}
  \begin{prooftree}
    \hypo{ \Gamma &\vdash A }
    \infer1{ \Gamma &\vdash A, \ldots, A }
    \hypo{ \Delta, A, \ldots, A \vdash \Theta }
    \infer[zigzag]2{ \Gamma, \Delta \vdash \Theta }
  \end{prooftree}
\end{example}


\section{License}

This work may be distributed and/or modified under the
conditions of the \LaTeX\ Project Public License, either version 1.3
of this license or (at your option) any later version.
The latest version of this license is in
\begin{center}
  \url{http://www.latex-project.org/lppl.txt}
\end{center}
and version 1.3 or later is part of all distributions of \LaTeX\
version 2005/12/01 or later.

This work has the LPPL maintenance status `maintained'.

The Current Maintainer of this work is Emmanuel Beffara.

This work consists of the files \texttt{ebproof.sty} and \texttt{ebproof.tex}.

\section{History}

This section lists the principal evolutions of the package, in reverse
chronological order.
\begin{description}
\item[Version 2.1]
  In preparation.
  \begin{itemize}
  \item Made the \env{prooftree} environment robust to use in tabular
    contexts.
  \end{itemize}
\item[Version 2.0]
  A complete rewrite of the code using the \LaTeX3 programming environment. 
  The incompatible changes from the user's point of view are the following:
  \begin{itemize}
  \item Proof statements are now writtten in lowercase ({i.e.} \cs{Infer} is
    now written \cs{infer} etc.) but the syntax is otherwise unchanged.
    The old uppercase commands still work but produce a deprecation warning,
    they will be removed in a future version.
  \item New styles are now defined using \cs{ebproofnewstyle} and
    \cs{ebproofnewrulestyle}. The previous method using PGF styles does not
    work anymore (because PGF is not used anymore).
  \end{itemize}
  The new commands and options are the following:
  \begin{itemize}
  \item The statement \cs{rewrite} generalizes \cs{Alter},
  \item The option \cmd{label axis} controls vertical alignment of labels.
  \end{itemize}
\item[Version 1.1]
  A bugfix release.
  In \cmd{template} options, one now uses \cs{inserttext} instead of \verb|#1|
  for the text arguments, which improves robustness.
\item[Version 1.0]
  The first public release.
\end{description}

\end{document}
